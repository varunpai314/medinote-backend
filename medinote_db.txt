-- Create Database and User
CREATE DATABASE medinote_db;
CREATE USER medinote_user WITH PASSWORD 'StrongSecurePassword123';
GRANT ALL PRIVILEGES ON DATABASE medinote_db TO medinote_user;

\c medinote_db;

-- Doctor Table
CREATE TABLE doctor (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    specialization VARCHAR(100),
    password_hash TEXT NOT NULL
);

-- Patient Table
CREATE TABLE patient (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    doctor_id UUID NOT NULL REFERENCES doctor(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    pronouns VARCHAR(20),
    background TEXT,
    medical_history TEXT,
    family_history TEXT,
    social_history TEXT,
    previous_treatment TEXT
);

-- Template Table
CREATE TABLE template (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(100) NOT NULL,
    type VARCHAR(20) CHECK (type IN ('default', 'predefined', 'custom'))
);

-- Session Table
CREATE TABLE session (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    doctor_id UUID NOT NULL REFERENCES doctor(id) ON DELETE CASCADE,
    patient_id UUID NOT NULL REFERENCES patient(id) ON DELETE CASCADE,
    template_id UUID REFERENCES template(id),
    session_title VARCHAR(150),
    session_summary TEXT,
    transcript_status VARCHAR(20) CHECK (transcript_status IN ('pending', 'processing', 'completed')),
    transcript TEXT,
    status VARCHAR(20) CHECK (status IN ('recording', 'completed', 'failed')),
    date DATE,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    duration INTERVAL
);

-- Audio Chunks
CREATE TABLE audio_chunk (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES session(id) ON DELETE CASCADE,
    chunk_number INTEGER NOT NULL,
    gcs_path TEXT NOT NULL,
    public_url TEXT,
    mime_type VARCHAR(50),
    upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Chunk Upload Notifications
CREATE TABLE chunk_upload_notification (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES session(id) ON DELETE CASCADE,
    chunk_number INTEGER NOT NULL,
    total_chunks_client INTEGER,
    is_last BOOLEAN,
    selected_template_id UUID REFERENCES template(id),
    model VARCHAR(50),
    notified_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Permissions
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO medinote_user;
